<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Playground - P2P Data Products</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .stats {
            color: #666;
            font-size: 14px;
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .main {
            background: white;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .module {
            margin-bottom: 20px;
        }
        
        .module-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #007bff;
        }
        
        .endpoint {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .endpoint:hover {
            background: #f8f9fa;
        }
        
        .endpoint.selected {
            background: #e7f3ff;
            border-left: 3px solid #007bff;
        }
        
        .method {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 600;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .method.GET { background: #61affe; color: white; }
        .method.POST { background: #49cc90; color: white; }
        .method.PUT { background: #fca130; color: white; }
        .method.DELETE { background: #f93e3e; color: white; }
        
        .endpoint-path {
            font-family: monospace;
            font-size: 13px;
        }
        
        .endpoint-desc {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .request-form {
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
        }
        
        textarea {
            font-family: monospace;
            resize: vertical;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            margin-left: 10px;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .response {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .response-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .response-meta span {
            font-size: 14px;
        }
        
        .status {
            font-weight: 600;
        }
        
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
        
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš€ API Playground</h1>
        <p>Test all module APIs â€¢ Auto-discovered from module.json</p>
        <div class="stats" id="stats">Loading...</div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <h3>API Explorer</h3>
            <div id="apiList">Loading APIs...</div>
        </div>
        
        <div class="main">
            <div id="requestSection">
                <h3>Request Builder</h3>
                <p style="color: #666; margin-bottom: 20px;">Select an endpoint from the left to test it</p>
                
                <div class="request-form">
                    <div class="form-group">
                        <label>HTTP Method</label>
                        <select id="method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Endpoint URL</label>
                        <input type="text" id="url" placeholder="/api/module/endpoint" />
                    </div>
                    
                    <div class="form-group hidden" id="paramsGroup">
                        <label>Path Parameters</label>
                        <input type="text" id="params" placeholder="e.g., feature_name for /<feature_name>/ endpoints" />
                    </div>
                    
                    <div class="form-group hidden" id="bodyGroup">
                        <label>Request Body (JSON)</label>
                        <textarea id="body" rows="10" placeholder='{\n  "key": "value"\n}'></textarea>
                    </div>
                    
                    <div>
                        <button class="btn-primary" onclick="executeRequest()">â–¶ Execute</button>
                        <button class="btn-secondary" onclick="clearForm()">Clear</button>
                    </div>
                </div>
                
                <div id="responseSection" class="hidden">
                    <h3>Response</h3>
                    <div class="response">
                        <div class="response-meta">
                            <span>Status: <span class="status" id="status">-</span></span>
                            <span>Time: <span id="time">-</span></span>
                            <button class="btn-secondary" onclick="copyResponse()">ðŸ“‹ Copy</button>
                        </div>
                        <pre id="response"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let discoveredAPIs = {};
        let selectedEndpoint = null;
        
        // Discover APIs on load
        window.addEventListener('load', () => {
            discoverAPIs();
        });
        
        async function discoverAPIs() {
            try {
                const response = await fetch('/api/playground/discover');
                const data = await response.json();
                
                if (data.success) {
                    discoveredAPIs = data.apis;
                    renderAPIList(data.apis);
                    updateStats(data.stats);
                } else {
                    document.getElementById('apiList').innerHTML = 
                        '<p style="color: red;">Failed to discover APIs: ' + data.error + '</p>';
                }
            } catch (error) {
                console.error('API discovery error:', error);
                document.getElementById('apiList').innerHTML = 
                    '<p style="color: red;">Error: ' + error.message + '</p>';
            }
        }
        
        function updateStats(stats) {
            document.getElementById('stats').textContent = 
                `Modules: ${stats.total_modules} â€¢ Endpoints: ${stats.total_endpoints}`;
        }
        
        function renderAPIList(apis) {
            const container = document.getElementById('apiList');
            container.innerHTML = '';
            
            Object.entries(apis).forEach(([moduleName, config]) => {
                const moduleDiv = document.createElement('div');
                moduleDiv.className = 'module';
                
                const title = document.createElement('div');
                title.className = 'module-title';
                title.textContent = config.displayName;
                moduleDiv.appendChild(title);
                
                config.endpoints.forEach(endpoint => {
                    const endpointDiv = document.createElement('div');
                    endpointDiv.className = 'endpoint';
                    endpointDiv.onclick = () => selectEndpoint(moduleName, endpoint, config.baseUrl);
                    
                    endpointDiv.innerHTML = `
                        <div>
                            <span class="method ${endpoint.method}">${endpoint.method}</span>
                            <span class="endpoint-path">${endpoint.path}</span>
                        </div>
                        ${endpoint.description ? `<div class="endpoint-desc">${endpoint.description}</div>` : ''}
                    `;
                    
                    moduleDiv.appendChild(endpointDiv);
                });
                
                container.appendChild(moduleDiv);
            });
        }
        
        function selectEndpoint(moduleName, endpoint, baseUrl) {
            // Remove previous selection
            document.querySelectorAll('.endpoint').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            selectedEndpoint = { moduleName, endpoint, baseUrl };
            
            // Populate form
            document.getElementById('method').value = endpoint.method;
            document.getElementById('url').value = baseUrl + endpoint.path;
            
            // Show/hide params
            const hasParams = endpoint.path.includes('<') && endpoint.path.includes('>');
            document.getElementById('paramsGroup').classList.toggle('hidden', !hasParams);
            
            // Show/hide body
            const hasBody = ['POST', 'PUT'].includes(endpoint.method);
            document.getElementById('bodyGroup').classList.toggle('hidden', !hasBody);
            
            // Clear previous response
            document.getElementById('responseSection').classList.add('hidden');
        }
        
        async function executeRequest() {
            const method = document.getElementById('method').value;
            let url = document.getElementById('url').value;
            const params = document.getElementById('params').value;
            const body = document.getElementById('body').value;
            
            // Handle path parameters
            if (url.includes('<') && url.includes('>') && params) {
                url = url.replace(/<[^>]+>/, params);
            }
            
            // Show loading
            document.getElementById('responseSection').classList.remove('hidden');
            document.getElementById('status').textContent = 'Loading...';
            document.getElementById('status').className = 'status';
            document.getElementById('time').textContent = '-';
            document.getElementById('response').textContent = 'Executing request...';
            
            try {
                const startTime = performance.now();
                
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                };
                
                if (['POST', 'PUT'].includes(method) && body.trim()) {
                    options.body = body;
                }
                
                const response = await fetch(url, options);
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                const contentType = response.headers.get('content-type');
                let responseData;
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }
                
                // Display response
                document.getElementById('status').textContent = `${response.status} ${response.ok ? 'OK' : 'Error'}`;
                document.getElementById('status').className = 'status ' + (response.ok ? 'success' : 'error');
                document.getElementById('time').textContent = `${duration}ms`;
                document.getElementById('response').textContent = 
                    typeof responseData === 'object' ? JSON.stringify(responseData, null, 2) : responseData;
                
            } catch (error) {
                document.getElementById('status').textContent = 'Error';
                document.getElementById('status').className = 'status error';
                document.getElementById('time').textContent = '-';
                document.getElementById('response').textContent = error.message;
            }
        }
        
        function clearForm() {
            document.getElementById('method').value = 'GET';
            document.getElementById('url').value = '';
            document.getElementById('params').value = '';
            document.getElementById('body').value = '';
            document.getElementById('responseSection').classList.add('hidden');
            
            // Remove selection
            document.querySelectorAll('.endpoint').forEach(el => el.classList.remove('selected'));
            selectedEndpoint = null;
        }
        
        function copyResponse() {
            const text = document.getElementById('response').textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Response copied to clipboard!');
            });
        }
    </script>
</head>
<body>
</body>
</html>