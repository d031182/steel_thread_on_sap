<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Data Products - Fiori Compliant v3.0.1</title>
    
    <script
        id="sap-ui-bootstrap"
        src="https://sdk.openui5.org/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m,sap.f,sap.ui.layout,sap.uxap"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true"
        data-sap-ui-resourceroots='{
            "p2p.dataproducts": "./"
        }'>
    </script>

    <!-- Client-side error logger - load FIRST to capture all errors -->
    <script src="../js/utils/clientErrorLogger.js"></script>

    <script type="module">
        import { DataProductsAPI } from '../js/api/dataProductsAPI.js';
        import { SQLExecutionAPI } from '../js/api/sqlExecutionAPI.js';
        import { HanaConnectionAPI } from '../js/api/hanaConnectionAPI.js';
        import { StorageService } from '../js/services/storageService.js';
        import { LogViewerAPI } from '../js/api/logViewerAPI.js';
        import { debugLogger } from '../js/utils/debugLogger.js';

        const storageService = new StorageService();
        const hanaConnectionAPI = new HanaConnectionAPI(storageService);
        const sqlExecutionAPI = new SQLExecutionAPI(storageService, hanaConnectionAPI);
        const dataProductsAPI = new DataProductsAPI();
        const logViewerAPI = new LogViewerAPI();

        sap.ui.getCore().attachInit(function() {
            "use strict";

            // Data model
            var oModel = new sap.ui.model.json.JSONModel({
                dataProducts: [],
                loading: false,
                hanaInstances: [],
                selectedInstance: null,
                sqlQuery: "",
                queryResults: [],
                executing: false
            });

            // Create Shell with Dynamic Page (proper Fiori floorplan)
            var oApp = new sap.m.App({
                id: "app",
                pages: [
                    new sap.f.DynamicPage({
                        id: "dynamicPage",
                        headerExpanded: true,
                        toggleHeaderOnTitleClick: false,
                        
                        // PROPER Fiori Title with breadcrumbs
                        title: new sap.f.DynamicPageTitle({
                            heading: [
                                new sap.m.Title({
                                    text: "Manage Data Products",
                                    level: "H1"
                                })
                            ],
                            snappedHeading: [
                                new sap.m.Title({
                                    text: "Manage Data Products",
                                    level: "H3"
                                })
                            ],
                            breadcrumbs: [
                                new sap.m.Breadcrumbs({
                                    links: [
                                        new sap.m.Link({ text: "Home" })
                                    ],
                                    currentLocationText: "Data Products"
                                })
                            ],
                            actions: [
                                new sap.m.Button({
                                    text: "Refresh",
                                    icon: "sap-icon://refresh",
                                    press: function() {
                                        loadDataProducts();
                                    }
                                }),
                                new sap.m.Button({
                                    text: "Logs",
                                    icon: "sap-icon://notes",
                                    press: function() {
                                        openLogViewerDialog();
                                    }
                                }),
                                new sap.m.Button({
                                    text: "Settings",
                                    icon: "sap-icon://action-settings"
                                })
                            ]
                        }),
                        
                        // PROPER Fiori Header with KPIs
                        header: new sap.f.DynamicPageHeader({
                            pinnable: true,
                            content: [
                                new sap.m.FlexBox({
                                    wrap: "Wrap",
                                    fitContainer: true,
                                    items: [
                                        // KPI Tiles
                                        new sap.m.VBox({
                                            items: [
                                                new sap.m.ObjectNumber({
                                                    number: "{/dataProducts/length}",
                                                    unit: "Products",
                                                    emphasized: true
                                                }),
                                                new sap.m.Label({
                                                    text: "Total Data Products"
                                                })
                                            ]
                                        }).addStyleClass("sapUiSmallMarginEnd sapUiSmallMarginBottom")
                                    ]
                                })
                            ]
                        }),
                        
                        // Content area with IconTabBar (proper Fiori pattern)
                        content: [
                            new sap.m.IconTabBar({
                                id: "mainTabBar",
                                expandable: false,
                                backgroundDesign: "Transparent",
                                items: [
                                    createDataProductsTab(),
                                    createSQLConsoleTab()
                                ]
                            })
                        ],
                        
                        // PROPER Footer with semantic actions
                        footer: new sap.m.OverflowToolbar({
                            content: [
                                new sap.m.ToolbarSpacer(),
                                new sap.m.Text({
                                    text: "P2P Data Products v3.0 ‚Ä¢ SAP Fiori Horizon"
                                }).addStyleClass("sapUiTinyMarginEnd"),
                                new sap.m.Button({
                                    text: "Switch to Custom",
                                    icon: "sap-icon://palette",
                                    type: "Transparent",
                                    press: function() {
                                        window.location.href = "../index.html";
                                    }
                                })
                            ]
                        })
                    })
                ]
            });

            // TAB 1: Data Products (List Report Pattern)
            function createDataProductsTab() {
                return new sap.m.IconTabFilter({
                    text: "Data Products",
                    icon: "sap-icon://product",
                    key: "catalog",
                    content: [
                        // Proper List Report with table and toolbar
                        new sap.m.VBox({
                            items: [
                                // Table Toolbar (Fiori standard)
                                new sap.m.OverflowToolbar({
                                    content: [
                                        new sap.m.Title({
                                            text: "Data Products ({/dataProducts/length})",
                                            level: "H2"
                                        }),
                                        new sap.m.ToolbarSpacer(),
                                        new sap.m.Button({
                                            text: "Load from HANA",
                                            icon: "sap-icon://database",
                                            type: "Emphasized",
                                            press: function() {
                                                loadDataProducts();
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "View Settings",
                                            icon: "sap-icon://action-settings",
                                            type: "Transparent"
                                        })
                                    ]
                                }),
                                
                                // Responsive Table (Fiori standard)
                                new sap.m.Table({
                                    id: "dataProductsTable",
                                    mode: "SingleSelectMaster",
                                    growing: true,
                                    growingThreshold: 20,
                                    noDataText: "No data products available. Click 'Load from HANA' to fetch data products.",
                                    selectionChange: function(oEvent) {
                                        var oItem = oEvent.getParameter("listItem");
                                        var oContext = oItem.getBindingContext();
                                        var oProduct = oContext.getObject();
                                        
                                        // Open detail dialog
                                        openProductDetailDialog(oProduct);
                                    },
                                    columns: [
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Product Name" }),
                                            minScreenWidth: "Tablet",
                                            demandPopin: true,
                                            hAlign: "Begin"
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Schema" }),
                                            minScreenWidth: "Desktop",
                                            demandPopin: true
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Version" }),
                                            minScreenWidth: "Tablet",
                                            demandPopin: false,
                                            hAlign: "Begin"
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Namespace" }),
                                            minScreenWidth: "Desktop",
                                            demandPopin: true
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Status" }),
                                            hAlign: "Center"
                                        })
                                    ],
                                    items: {
                                        path: "/dataProducts",
                                        template: new sap.m.ColumnListItem({
                                            type: "Navigation",
                                            cells: [
                                                new sap.m.ObjectIdentifier({
                                                    title: "{productName}",
                                                    text: "{owner}"
                                                }),
                                                new sap.m.Text({
                                                    text: "{schemaName}",
                                                    wrapping: false
                                                }),
                                                new sap.m.ObjectStatus({
                                                    text: "{version}",
                                                    state: "Information"
                                                }),
                                                new sap.m.Text({
                                                    text: "{namespace}"
                                                }),
                                                new sap.m.ObjectStatus({
                                                    text: "Active",
                                                    state: "Success",
                                                    icon: "sap-icon://accept"
                                                })
                                            ]
                                        })
                                    }
                                })
                            ]
                        }).addStyleClass("sapUiContentPadding")
                    ]
                });
            }

            // TAB 2: SQL Console (Proper Form Layout)
            function createSQLConsoleTab() {
                return new sap.m.IconTabFilter({
                    text: "SQL Console",
                    icon: "sap-icon://database",
                    key: "sql",
                    content: [
                        new sap.m.VBox({
                            items: [
                                // Proper toolbar
                                new sap.m.OverflowToolbar({
                                    content: [
                                        new sap.m.Title({
                                            text: "SQL Console",
                                            level: "H2"
                                        }),
                                        new sap.m.ToolbarSpacer(),
                                        new sap.m.Button({
                                            text: "Execute",
                                            icon: "sap-icon://play",
                                            type: "Emphasized",
                                            enabled: "{= ${/sqlQuery}.trim().length > 0 && !${/executing}}",
                                            press: function() {
                                                executeSQL();
                                            }
                                        })
                                    ]
                                }),
                                
                                // Instance selection
                                new sap.ui.layout.form.SimpleForm({
                                    editable: true,
                                    layout: "ResponsiveGridLayout",
                                    labelSpanXL: 2,
                                    labelSpanL: 2,
                                    labelSpanM: 2,
                                    emptySpanXL: 0,
                                    emptySpanL: 0,
                                    emptySpanM: 0,
                                    columnsXL: 1,
                                    columnsL: 1,
                                    columnsM: 1,
                                    content: [
                                        new sap.m.Label({ text: "HANA Instance:" }),
                                        new sap.m.Select({
                                            width: "100%",
                                            items: {
                                                path: "/hanaInstances",
                                                template: new sap.ui.core.Item({
                                                    key: "{id}",
                                                    text: "{name}"
                                                })
                                            },
                                            change: function(oEvent) {
                                                var sKey = oEvent.getParameter("selectedItem").getKey();
                                                oModel.setProperty("/selectedInstance", sKey);
                                            }
                                        })
                                    ]
                                }).addStyleClass("sapUiSmallMarginTop"),
                                
                                // Query templates (proper button group)
                                new sap.m.Toolbar({
                                    content: [
                                        new sap.m.Label({ text: "Templates:" }),
                                        new sap.m.Button({
                                            text: "List Schemas",
                                            press: function() {
                                                oModel.setProperty("/sqlQuery", 
                                                    "SELECT SCHEMA_NAME, SCHEMA_OWNER\nFROM SYS.SCHEMAS\nORDER BY SCHEMA_NAME;");
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "List Tables",
                                            press: function() {
                                                oModel.setProperty("/sqlQuery",
                                                    "SELECT TABLE_NAME, TABLE_TYPE\nFROM SYS.TABLES\nWHERE SCHEMA_NAME LIKE '_SAP_DATAPRODUCT%';");
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "Check User",
                                            press: function() {
                                                oModel.setProperty("/sqlQuery",
                                                    "SELECT USER_NAME, CREATOR, CREATE_TIME\nFROM SYS.USERS\nWHERE USER_NAME = 'P2P_DP_USER';");
                                            }
                                        })
                                    ]
                                }).addStyleClass("sapUiTinyMarginTop"),
                                
                                // SQL Editor with proper label
                                new sap.m.Label({ 
                                    text: "SQL Query:",
                                    labelFor: "sqlEditor"
                                }).addStyleClass("sapUiTinyMarginTop"),
                                new sap.m.TextArea({
                                    id: "sqlEditor",
                                    value: "{/sqlQuery}",
                                    rows: 10,
                                    width: "100%",
                                    placeholder: "Enter SQL query here...",
                                    valueLiveUpdate: true
                                }).addStyleClass("sapUiTinyMarginTop"),
                                
                                // Results panel
                                new sap.m.Panel({
                                    headerText: "Query Results ({/queryResults/length} rows)",
                                    visible: "{= ${/queryResults}.length > 0}",
                                    content: [
                                        new sap.m.MessageStrip({
                                            text: "Query executed successfully in {/executionTime}ms",
                                            type: "Success",
                                            showIcon: true
                                        }).addStyleClass("sapUiTinyMarginBottom"),
                                        new sap.m.Text({
                                            text: "Showing first 100 rows. Use Data Products tab to view full table data."
                                        })
                                    ]
                                }).addStyleClass("sapUiSmallMarginTop")
                            ]
                        }).addStyleClass("sapUiContentPadding")
                    ]
                });
            }

            // Open Product Detail Dialog (Master-Detail Pattern)
            async function openProductDetailDialog(oProduct) {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    // Load tables for this product
                    const result = await dataProductsAPI.getTables(oProduct.schemaName);
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || "Failed to load tables");
                    }
                    
                    const tables = result.tables || [];
                    
                    // Create detail dialog with Object Page layout
                    const oDialog = new sap.m.Dialog({
                        title: oProduct.displayName || oProduct.productName,
                        contentWidth: "80%",
                        contentHeight: "80%",
                        resizable: true,
                        draggable: true,
                        verticalScrolling: false,
                        content: [
                            new sap.uxap.ObjectPageLayout({
                                showTitleInHeaderContent: true,
                                headerTitle: new sap.uxap.ObjectPageHeader({
                                    objectTitle: oProduct.displayName || oProduct.productName,
                                    objectSubtitle: oProduct.namespace,
                                    actions: [
                                        new sap.m.Button({
                                            text: "Refresh",
                                            icon: "sap-icon://refresh",
                                            press: function() {
                                                oDialog.close();
                                                openProductDetailDialog(oProduct);
                                            }
                                        })
                                    ],
                                    breadcrumbs: new sap.m.Breadcrumbs({
                                        links: [
                                            new sap.m.Link({
                                                text: "Data Products",
                                                press: function() {
                                                    oDialog.close();
                                                }
                                            })
                                        ],
                                        currentLocationText: oProduct.productName
                                    })
                                }),
                                headerContent: [
                                    new sap.m.ObjectAttribute({
                                        title: "Version",
                                        text: oProduct.version
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Schema",
                                        text: oProduct.schemaName
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Tables",
                                        text: tables.length + " tables"
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Created",
                                        text: oProduct.createTime || "N/A"
                                    })
                                ],
                                sections: [
                                    new sap.uxap.ObjectPageSection({
                                        title: "Tables",
                                        subSections: [
                                            new sap.uxap.ObjectPageSubSection({
                                                blocks: [
                                                    new sap.m.Table({
                                                        mode: "None",
                                                        columns: [
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Table Name" })
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Type" }),
                                                                hAlign: "Center",
                                                                width: "120px"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Records" }),
                                                                hAlign: "End",
                                                                width: "120px"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Actions" }),
                                                                hAlign: "Center",
                                                                width: "250px"
                                                            })
                                                        ],
                                                        items: tables.map(function(table) {
                                                            return new sap.m.ColumnListItem({
                                                                cells: [
                                                                    new sap.m.ObjectIdentifier({
                                                                        title: table.TABLE_NAME,
                                                                        titleActive: false
                                                                    }),
                                                                    new sap.m.ObjectStatus({
                                                                        text: table.TABLE_TYPE,
                                                                        state: "Information"
                                                                    }),
                                                                    new sap.m.ObjectNumber({
                                                                        number: (table.RECORD_COUNT || 0).toLocaleString(),
                                                                        emphasized: table.RECORD_COUNT > 0
                                                                    }),
                                                                    new sap.m.HBox({
                                                                        justifyContent: "Center",
                                                                        items: [
                                                                            new sap.m.Button({
                                                                                text: "Structure",
                                                                                icon: "sap-icon://table-view",
                                                                                press: async function() {
                                                                                    try {
                                                                                        await showTableStructure(oProduct.schemaName, table.TABLE_NAME, oDialog);
                                                                                    } catch (error) {
                                                                                        console.error('[CRITICAL] Structure button error:', error);
                                                                                        sap.m.MessageBox.error("Failed to open structure: " + error.message);
                                                                                    }
                                                                                }
                                                                            }),
                                                                            new sap.m.Button({
                                                                                text: "View Data",
                                                                                icon: "sap-icon://database",
                                                                                type: "Emphasized",
                                                                                press: function() {
                                                                                    showTableData(oProduct.schemaName, table.TABLE_NAME, table.RECORD_COUNT, oDialog);
                                                                                }
                                                                            }).addStyleClass("sapUiTinyMarginBegin")
                                                                        ]
                                                                    })
                                                                ]
                                                            });
                                                        })
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oDialog.destroy();
                            // Deselect table row to allow re-selection of same product
                            var oTable = sap.ui.getCore().byId("dataProductsTable");
                            if (oTable) {
                                oTable.removeSelections(true);
                            }
                        }
                    });
                    
                    oDialog.open();
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error loading product details: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Show Table Structure
            async function showTableStructure(schema, table, parentDialog) {
                const startTime = debugLogger.entry('showTableStructure', { schema, table });
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log('Calling getTableStructure API');
                    const result = await dataProductsAPI.getTableStructure(schema, table);
                    debugLogger.inspect('API Result', result);
                    
                    if (!result || !result.success) {
                        const errorMsg = result?.error?.message || "Failed to load structure";
                        throw new Error(errorMsg);
                    }
                    
                    const columns = result.columns || [];
                    debugLogger.log(`Found ${columns.length} columns`);
                    debugLogger.table('First 3 Columns', columns.slice(0, 3));
                    
                    const oStructureDialog = new sap.m.Dialog({
                        title: "Structure: " + table,
                        contentWidth: "70%",
                        contentHeight: "70%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.Table({
                                columns: [
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Column" }), width: "30%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Data Type" }), width: "25%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Length" }), hAlign: "End", width: "15%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Nullable" }), hAlign: "Center", width: "15%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Key" }), hAlign: "Center", width: "15%" })
                                ],
                                items: columns.map(function(col) {
                                    return new sap.m.ColumnListItem({
                                        cells: [
                                            new sap.m.Text({ text: col.name || col.COLUMN_NAME }),
                                            new sap.m.Text({ text: col.dataType || col.DATA_TYPE_NAME }),
                                            new sap.m.Text({ text: col.length || col.LENGTH || "N/A" }),
                                            new sap.m.ObjectStatus({
                                                text: (col.nullable !== undefined ? col.nullable : col.IS_NULLABLE) ? "Yes" : "No",
                                                state: (col.nullable !== undefined ? col.nullable : col.IS_NULLABLE) ? "Warning" : "Success"
                                            }),
                                            new sap.m.Text({
                                                text: (col.isPrimaryKey || col.IS_PRIMARY_KEY) ? "üîë" : ""
                                            })
                                        ]
                                    });
                                })
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oStructureDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oStructureDialog.destroy();
                        }
                    });
                    
                    oStructureDialog.open();
                    debugLogger.exit('showTableStructure', { dialogOpened: true }, startTime);
                    
                } catch (error) {
                    debugLogger.error('showTableStructure', error);
                    const errorMsg = error?.message || error?.error?.message || String(error);
                    sap.m.MessageBox.error("Error loading table structure: " + errorMsg);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Show Table Data
            async function showTableData(schema, table, recordCount, parentDialog) {
                const startTime = debugLogger.entry('showTableData', { schema, table, recordCount });
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log('Calling queryTable API');
                    const result = await dataProductsAPI.queryTable(schema, table, { limit: 100, offset: 0 });
                    debugLogger.inspect('Query Result', result);
                    
                    if (!result || !result.success) {
                        const errorMsg = result?.error?.message || "Failed to load data";
                        throw new Error(errorMsg);
                    }
                    
                    const rows = result.rows || [];
                    const columns = result.columns || [];
                    const totalCount = result.totalCount || recordCount || 0;
                    
                    // Create table columns dynamically
                    const tableColumns = columns.map(function(col) {
                        return new sap.m.Column({
                            header: new sap.m.Label({ text: col.name }),
                            minScreenWidth: "Tablet",
                            demandPopin: true
                        });
                    });
                    
                    // Create table items
                    const tableItems = rows.map(function(row) {
                        const cells = columns.map(function(col) {
                            const value = row[col.name];
                            return new sap.m.Text({
                                text: value === null ? "NULL" : String(value)
                            });
                        });
                        
                        return new sap.m.ColumnListItem({
                            cells: cells
                        });
                    });
                    
                    const oDataDialog = new sap.m.Dialog({
                        title: "Data: " + table,
                        contentWidth: "90%",
                        contentHeight: "80%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.VBox({
                                items: [
                                    new sap.m.MessageStrip({
                                        text: "Showing " + rows.length + " of " + totalCount.toLocaleString() + " records ‚Ä¢ " + columns.length + " columns displayed ‚Ä¢ Execution: " + result.executionTime + "ms",
                                        type: "Information",
                                        showIcon: true
                                    }).addStyleClass("sapUiTinyMarginBottom"),
                                    new sap.m.MessageStrip({
                                        text: "Note: Displaying first 10 essential columns for readability. Use 'Structure' button to view all columns.",
                                        type: "Warning",
                                        showIcon: true,
                                        visible: columns.length >= 10
                                    }).addStyleClass("sapUiTinyMarginBottom"),
                                    new sap.m.Table({
                                        columns: tableColumns,
                                        items: tableItems,
                                        growing: false
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oDataDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oDataDialog.destroy();
                        }
                    });
                    
                    oDataDialog.open();
                    debugLogger.exit('showTableData', { rowsDisplayed: rows.length }, startTime);
                    
                } catch (error) {
                    debugLogger.error('showTableData', error);
                    sap.m.MessageBox.error("Error loading table data: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Load data products from HANA
            async function loadDataProducts() {
                const startTime = debugLogger.entry('loadDataProducts', {});
                oModel.setProperty("/loading", true);
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log('Calling listDataProducts API');
                    const result = await dataProductsAPI.listDataProducts();
                    debugLogger.inspect('List Result', result);
                    
                    if (result.success) {
                        oModel.setProperty("/dataProducts", result.dataProducts);
                        sap.m.MessageToast.show(`Loaded ${result.count} data products from HANA`);
                        debugLogger.exit('loadDataProducts', { count: result.count }, startTime);
                    } else {
                        sap.m.MessageBox.error("Failed to load data products: " + 
                            (result.error ? result.error.message : "Unknown error"));
                    }
                } catch (error) {
                    debugLogger.error('loadDataProducts', error);
                    sap.m.MessageBox.error("Connection Error", {
                        details: error.message
                    });
                } finally {
                    oModel.setProperty("/loading", false);
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Open Log Viewer Dialog
            async function openLogViewerDialog() {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    // Fetch logs from API
                    const result = await logViewerAPI.getLogs({ limit: 100 });
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || "Failed to load logs");
                    }
                    
                    const logs = result.logs || [];
                    
                    // Calculate statistics from logs
                    const stats = {
                        total: logs.length,
                        INFO: logs.filter(l => l.level === 'INFO').length,
                        WARNING: logs.filter(l => l.level === 'WARNING').length,
                        ERROR: logs.filter(l => l.level === 'ERROR').length
                    };
                    
                    // Create log viewer dialog
                    const oLogDialog = new sap.m.Dialog({
                        title: "Application Logs",
                        contentWidth: "80%",
                        contentHeight: "70%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.VBox({
                                items: [
                                    // Toolbar with filters and actions
                                    new sap.m.OverflowToolbar({
                                        content: [
                                            new sap.m.Title({
                                                text: "Logs (" + logs.length + ")",
                                                level: "H2"
                                            }),
                                            new sap.m.ToolbarSpacer(),
                                            new sap.m.Label({
                                                text: "Filter:"
                                            }),
                                            new sap.m.SegmentedButton({
                                                selectedKey: "ALL",
                                                selectionChange: async function(oEvent) {
                                                    const level = oEvent.getParameter("item").getKey();
                                                    await refreshLogs(oLogDialog, level);
                                                },
                                                items: [
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "ALL",
                                                        text: "All (" + (stats.total || 0) + ")"
                                                    }),
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "INFO",
                                                        text: "Info (" + (stats.INFO || 0) + ")"
                                                    }),
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "WARNING",
                                                        text: "Warning (" + (stats.WARNING || 0) + ")"
                                                    }),
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "ERROR",
                                                        text: "Error (" + (stats.ERROR || 0) + ")"
                                                    })
                                                ]
                                            }),
                                            new sap.m.Button({
                                                icon: "sap-icon://refresh",
                                                tooltip: "Refresh",
                                                press: async function() {
                                                    await refreshLogs(oLogDialog, "ALL");
                                                }
                                            }),
                                            new sap.m.Button({
                                                icon: "sap-icon://delete",
                                                tooltip: "Clear Logs",
                                                press: async function() {
                                                    sap.m.MessageBox.confirm("Are you sure you want to clear all logs?", {
                                                        onClose: async function(oAction) {
                                                            if (oAction === sap.m.MessageBox.Action.OK) {
                                                                await logViewerAPI.clearLogs();
                                                                await refreshLogs(oLogDialog, "ALL");
                                                                sap.m.MessageToast.show("Logs cleared");
                                                            }
                                                        }
                                                    });
                                                }
                                            }),
                                            new sap.m.Button({
                                                id: "debugModeButton",
                                                text: debugLogger.isEnabled() ? "üêõ Debug Mode: ON" : "üêõ Debug Mode: OFF",
                                                type: debugLogger.isEnabled() ? "Emphasized" : "Default",
                                                tooltip: "Toggle debug mode for detailed troubleshooting logs",
                                                press: function() {
                                                    const newState = debugLogger.toggle();
                                                    const oButton = sap.ui.getCore().byId("debugModeButton");
                                                    if (oButton) {
                                                        oButton.setText(newState ? "üêõ Debug Mode: ON" : "üêõ Debug Mode: OFF");
                                                        oButton.setType(newState ? "Emphasized" : "Default");
                                                    }
                                                    sap.m.MessageToast.show(
                                                        newState ? 
                                                        "Debug Mode enabled - All function calls will be logged in console" :
                                                        "Debug Mode disabled"
                                                    );
                                                }
                                            })
                                        ]
                                    }),
                                    
                                    // Logs table
                                    new sap.m.Table({
                                        id: "logsTable",
                                        growing: true,
                                        growingThreshold: 50,
                                        noDataText: "No logs available",
                                        columns: [
                                            new sap.m.Column({
                                                header: new sap.m.Label({ text: "Time" }),
                                                width: "160px",
                                                minScreenWidth: "Tablet",
                                                demandPopin: false
                                            }),
                                            new sap.m.Column({
                                                header: new sap.m.Label({ text: "Level" }),
                                                width: "100px",
                                                hAlign: "Center"
                                            }),
                                            new sap.m.Column({
                                                header: new sap.m.Label({ text: "Message" }),
                                                minScreenWidth: "Tablet",
                                                demandPopin: true
                                            })
                                        ],
                                        items: logs.map(function(log) {
                                            // Determine color based on level
                                            let state = "None";
                                            let icon = "sap-icon://message-information";
                                            
                                            if (log.level === "ERROR") {
                                                state = "Error";
                                                icon = "sap-icon://message-error";
                                            } else if (log.level === "WARNING") {
                                                state = "Warning";
                                                icon = "sap-icon://message-warning";
                                            } else if (log.level === "INFO") {
                                                state = "Information";
                                                icon = "sap-icon://message-information";
                                            }
                                            
                                            return new sap.m.ColumnListItem({
                                                cells: [
                                                    new sap.m.Text({
                                                        text: logViewerAPI.formatTimestamp(log.timestamp)
                                                    }),
                                                    new sap.m.ObjectStatus({
                                                        text: log.level,
                                                        state: state,
                                                        icon: icon
                                                    }),
                                                    new sap.m.Text({
                                                        text: log.message,
                                                        wrapping: true
                                                    })
                                                ]
                                            });
                                        })
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oLogDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oLogDialog.destroy();
                        }
                    });
                    
                    oLogDialog.open();
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error loading logs: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }
            
            // Refresh logs in dialog
            async function refreshLogs(oDialog, level) {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    const fetchLevel = (level === 'ALL') ? null : level;
                    const result = await logViewerAPI.getLogs({ level: fetchLevel, limit: 100 });
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || "Failed to refresh logs");
                    }
                    
                    const logs = result.logs || [];
                    
                    // Calculate statistics from logs
                    const stats = {
                        total: logs.length,
                        INFO: logs.filter(l => l.level === 'INFO').length,
                        WARNING: logs.filter(l => l.level === 'WARNING').length,
                        ERROR: logs.filter(l => l.level === 'ERROR').length
                    };
                    
                    // Update table
                    const oTable = sap.ui.getCore().byId("logsTable");
                    if (oTable) {
                        oTable.destroyItems();
                        
                        logs.forEach(function(log) {
                            let state = "None";
                            let icon = "sap-icon://message-information";
                            
                            if (log.level === "ERROR") {
                                state = "Error";
                                icon = "sap-icon://message-error";
                            } else if (log.level === "WARNING") {
                                state = "Warning";
                                icon = "sap-icon://message-warning";
                            } else if (log.level === "INFO") {
                                state = "Information";
                                icon = "sap-icon://message-information";
                            }
                            
                            oTable.addItem(new sap.m.ColumnListItem({
                                cells: [
                                    new sap.m.Text({
                                        text: logViewerAPI.formatTimestamp(log.timestamp)
                                    }),
                                    new sap.m.ObjectStatus({
                                        text: log.level,
                                        state: state,
                                        icon: icon
                                    }),
                                    new sap.m.Text({
                                        text: log.message,
                                        wrapping: true
                                    })
                                ]
                            }));
                        });
                    }
                    
                    sap.m.MessageToast.show("Logs refreshed (" + logs.length + " entries)");
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error refreshing logs: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Execute SQL
            async function executeSQL() {
                const sql = oModel.getProperty("/sqlQuery");
                const instanceId = oModel.getProperty("/selectedInstance");
                
                if (!instanceId) {
                    sap.m.MessageBox.warning("Please select a HANA instance");
                    return;
                }
                
                oModel.setProperty("/executing", true);
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    const result = await sqlExecutionAPI.executeQuery(instanceId, sql);
                    
                    if (result.success) {
                        oModel.setProperty("/queryResults", result.rows || []);
                        oModel.setProperty("/executionTime", result.executionTime);
                        sap.m.MessageToast.show(`Query executed: ${result.rowCount} rows in ${result.executionTime}ms`);
                    } else {
                        sap.m.MessageBox.error("Query Failed", {
                            details: result.error.message
                        });
                    }
                } catch (error) {
                    sap.m.MessageBox.error("Execution Error", {
                        details: error.message
                    });
                } finally {
                    oModel.setProperty("/executing", false);
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Set model and render
            oApp.setModel(oModel);
            oApp.placeAt("content");
            
            // Load initial data
            (async function() {
                try {
                    // Load HANA instances
                    const instances = await hanaConnectionAPI.getInstances();
                    oModel.setProperty("/hanaInstances", instances);
                    if (instances.length > 0) {
                        oModel.setProperty("/selectedInstance", instances[0].id);
                    }
                    
                    // Auto-load data products
                    await loadDataProducts();
                } catch (error) {
                    console.error("Initialization error:", error);
                }
            })();
        });
    </script>
</head>
<body class="sapUiBody" id="content">
    <div class="sapUiSizeCompact"></div>
</body>
</html>
