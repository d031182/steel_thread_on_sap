<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Data Products - Fiori Compliant v3.0.1</title>
    
    <script
        id="sap-ui-bootstrap"
        src="https://sdk.openui5.org/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m,sap.f,sap.ui.layout,sap.uxap"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true"
        data-sap-ui-resourceroots='{
            "p2p.dataproducts": "./"
        }'>
    </script>

    <!-- Client-side error logger - load FIRST to capture all errors -->
    <script src="../js/utils/clientErrorLogger.js"></script>

    <script type="module">
        import { DataProductsAPI } from '../js/api/dataProductsAPI.js';
        import { SQLExecutionAPI } from '../js/api/sqlExecutionAPI.js';
        import { HanaConnectionAPI } from '../js/api/hanaConnectionAPI.js';
        import { StorageService } from '../js/services/storageService.js';
        import { LogViewerAPI } from '../js/api/logViewerAPI.js';
        import { debugLogger } from '../js/utils/debugLogger.js';

        const storageService = new StorageService();
        const hanaConnectionAPI = new HanaConnectionAPI(storageService);
        const sqlExecutionAPI = new SQLExecutionAPI(storageService, hanaConnectionAPI);
        const dataProductsAPI = new DataProductsAPI();
        const logViewerAPI = new LogViewerAPI();

        sap.ui.getCore().attachInit(function() {
            "use strict";

            // Data model
            var oModel = new sap.ui.model.json.JSONModel({
                dataProducts: [],
                loading: false,
                hanaInstances: [],
                selectedInstance: null,
                selectedDataSource: "hana",  // 'hana' or 'sqlite'
                sqlQuery: "",
                queryResults: [],
                executing: false
            });

            // Create Shell with Dynamic Page (proper Fiori floorplan)
            var oApp = new sap.m.App({
                id: "app",
                pages: [
                    new sap.f.DynamicPage({
                        id: "dynamicPage",
                        headerExpanded: true,
                        toggleHeaderOnTitleClick: false,
                        
                        // PROPER Fiori Title with breadcrumbs
                        title: new sap.f.DynamicPageTitle({
                            heading: [
                                new sap.m.Title({
                                    text: "Manage Data Products",
                                    level: "H1"
                                })
                            ],
                            snappedHeading: [
                                new sap.m.Title({
                                    text: "Manage Data Products",
                                    level: "H3"
                                })
                            ],
                            breadcrumbs: [
                                new sap.m.Breadcrumbs({
                                    links: [
                                        new sap.m.Link({ text: "Home" })
                                    ],
                                    currentLocationText: "Data Products"
                                })
                            ],
                            actions: [
                                new sap.m.Button({
                                    text: "Refresh",
                                    icon: "sap-icon://refresh",
                                    press: function() {
                                        loadDataProducts();
                                    }
                                }),
                                new sap.m.Button({
                                    text: "Logs",
                                    icon: "sap-icon://notes",
                                    press: function() {
                                        openLogViewerDialog();
                                    }
                                }),
                                new sap.m.Button({
                                    text: "Settings",
                                    icon: "sap-icon://action-settings",
                                    press: function() {
                                        openFeatureManagerDialog();
                                    }
                                })
                            ]
                        }),
                        
                        // PROPER Fiori Header with KPIs
                        header: new sap.f.DynamicPageHeader({
                            pinnable: true,
                            content: [
                                new sap.m.FlexBox({
                                    wrap: "Wrap",
                                    fitContainer: true,
                                    items: [
                                        // KPI Tiles
                                        new sap.m.VBox({
                                            items: [
                                                new sap.m.ObjectNumber({
                                                    number: "{/dataProducts/length}",
                                                    unit: "Products",
                                                    emphasized: true
                                                }),
                                                new sap.m.Label({
                                                    text: "Total Data Products"
                                                })
                                            ]
                                        }).addStyleClass("sapUiSmallMarginEnd sapUiSmallMarginBottom")
                                    ]
                                })
                            ]
                        }),
                        
                        // Content area with IconTabBar (proper Fiori pattern)
                        content: [
                            new sap.m.IconTabBar({
                                id: "mainTabBar",
                                expandable: false,
                                backgroundDesign: "Transparent",
                                items: [
                                    createDataProductsTab(),
                                    createSQLConsoleTab()
                                ]
                            })
                        ],
                        
                        // PROPER Footer with semantic actions
                        footer: new sap.m.OverflowToolbar({
                            content: [
                                new sap.m.ToolbarSpacer(),
                                new sap.m.Text({
                                    text: "P2P Data Products v3.0 â€¢ SAP Fiori Horizon"
                                }).addStyleClass("sapUiTinyMarginEnd"),
                                new sap.m.Button({
                                    text: "Switch to Custom",
                                    icon: "sap-icon://palette",
                                    type: "Transparent",
                                    press: function() {
                                        window.location.href = "../index.html";
                                    }
                                })
                            ]
                        })
                    })
                ]
            });

            // TAB 1: Data Products (List Report Pattern)
            function createDataProductsTab() {
                return new sap.m.IconTabFilter({
                    text: "Data Products",
                    icon: "sap-icon://product",
                    key: "catalog",
                    content: [
                        // Proper List Report with table and toolbar
                        new sap.m.VBox({
                            items: [
                                // Table Toolbar (Fiori standard)
                                new sap.m.OverflowToolbar({
                                    content: [
                                        new sap.m.Title({
                                            text: "Data Products ({/dataProducts/length})",
                                            level: "H2"
                                        }),
                                        new sap.m.ToolbarSpacer(),
                                        new sap.m.Label({ text: "Source:" }),
                                        new sap.m.SegmentedButton({
                                            selectedKey: "{/selectedDataSource}",
                                            items: [
                                                new sap.m.SegmentedButtonItem({ key: "hana", icon: "sap-icon://database", text: "HANA" }),
                                                new sap.m.SegmentedButtonItem({ key: "sqlite", icon: "sap-icon://folder-full", text: "SQLite" })
                                            ],
                                            selectionChange: function(oEvent) {
                                                var src = oEvent.getParameter("item").getKey();
                                                oModel.setProperty("/selectedDataSource", src);
                                                sap.m.MessageToast.show(src === "sqlite" ? "SQLite: PurchaseOrder sample" : "HANA Cloud: Live data");
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "Load",
                                            icon: "sap-icon://refresh",
                                            type: "Emphasized",
                                            press: function() {
                                                loadDataProducts();
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "View Settings",
                                            icon: "sap-icon://action-settings",
                                            type: "Transparent"
                                        })
                                    ]
                                }),
                                
                                // Responsive Table (Fiori standard)
                                new sap.m.Table({
                                    id: "dataProductsTable",
                                    mode: "SingleSelectMaster",
                                    growing: true,
                                    growingThreshold: 20,
                                    noDataText: "No data products available. Click 'Load from HANA' to fetch data products.",
                                    selectionChange: function(oEvent) {
                                        var oItem = oEvent.getParameter("listItem");
                                        var oContext = oItem.getBindingContext();
                                        var oProduct = oContext.getObject();
                                        
                                        // Open detail dialog
                                        openProductDetailDialog(oProduct);
                                    },
                                    columns: [
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Product Name" }),
                                            minScreenWidth: "Tablet",
                                            demandPopin: true,
                                            hAlign: "Begin"
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Schema" }),
                                            minScreenWidth: "Desktop",
                                            demandPopin: true
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Version" }),
                                            minScreenWidth: "Tablet",
                                            demandPopin: false,
                                            hAlign: "Begin"
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Namespace" }),
                                            minScreenWidth: "Desktop",
                                            demandPopin: true
                                        }),
                                        new sap.m.Column({
                                            header: new sap.m.Label({ text: "Status" }),
                                            hAlign: "Center"
                                        })
                                    ],
                                    items: {
                                        path: "/dataProducts",
                                        template: new sap.m.ColumnListItem({
                                            type: "Navigation",
                                            cells: [
                                                new sap.m.ObjectIdentifier({
                                                    title: "{productName}",
                                                    text: "{owner}"
                                                }),
                                                new sap.m.Text({
                                                    text: "{schemaName}",
                                                    wrapping: false
                                                }),
                                                new sap.m.ObjectStatus({
                                                    text: "{version}",
                                                    state: "Information"
                                                }),
                                                new sap.m.Text({
                                                    text: "{namespace}"
                                                }),
                                                new sap.m.ObjectStatus({
                                                    text: "Active",
                                                    state: "Success",
                                                    icon: "sap-icon://accept"
                                                })
                                            ]
                                        })
                                    }
                                })
                            ]
                        }).addStyleClass("sapUiContentPadding")
                    ]
                });
            }

            // TAB 2: SQL Console (Proper Form Layout)
            function createSQLConsoleTab() {
                return new sap.m.IconTabFilter({
                    text: "SQL Console",
                    icon: "sap-icon://database",
                    key: "sql",
                    content: [
                        new sap.m.VBox({
                            items: [
                                // Proper toolbar
                                new sap.m.OverflowToolbar({
                                    content: [
                                        new sap.m.Title({
                                            text: "SQL Console",
                                            level: "H2"
                                        }),
                                        new sap.m.ToolbarSpacer(),
                                        new sap.m.Button({
                                            text: "Execute",
                                            icon: "sap-icon://play",
                                            type: "Emphasized",
                                            enabled: "{= ${/sqlQuery}.trim().length > 0 && !${/executing}}",
                                            press: function() {
                                                executeSQL();
                                            }
                                        })
                                    ]
                                }),
                                
                                // Instance selection
                                new sap.ui.layout.form.SimpleForm({
                                    editable: true,
                                    layout: "ResponsiveGridLayout",
                                    labelSpanXL: 2,
                                    labelSpanL: 2,
                                    labelSpanM: 2,
                                    emptySpanXL: 0,
                                    emptySpanL: 0,
                                    emptySpanM: 0,
                                    columnsXL: 1,
                                    columnsL: 1,
                                    columnsM: 1,
                                    content: [
                                        new sap.m.Label({ text: "HANA Instance:" }),
                                        new sap.m.Select({
                                            width: "100%",
                                            items: {
                                                path: "/hanaInstances",
                                                template: new sap.ui.core.Item({
                                                    key: "{id}",
                                                    text: "{name}"
                                                })
                                            },
                                            change: function(oEvent) {
                                                var sKey = oEvent.getParameter("selectedItem").getKey();
                                                oModel.setProperty("/selectedInstance", sKey);
                                            }
                                        })
                                    ]
                                }).addStyleClass("sapUiSmallMarginTop"),
                                
                                // Query templates (proper button group)
                                new sap.m.Toolbar({
                                    content: [
                                        new sap.m.Label({ text: "Templates:" }),
                                        new sap.m.Button({
                                            text: "List Schemas",
                                            press: function() {
                                                oModel.setProperty("/sqlQuery", 
                                                    "SELECT SCHEMA_NAME, SCHEMA_OWNER\nFROM SYS.SCHEMAS\nORDER BY SCHEMA_NAME;");
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "List Tables",
                                            press: function() {
                                                oModel.setProperty("/sqlQuery",
                                                    "SELECT TABLE_NAME, TABLE_TYPE\nFROM SYS.TABLES\nWHERE SCHEMA_NAME LIKE '_SAP_DATAPRODUCT%';");
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "Check User",
                                            press: function() {
                                                oModel.setProperty("/sqlQuery",
                                                    "SELECT USER_NAME, CREATOR, CREATE_TIME\nFROM SYS.USERS\nWHERE USER_NAME = 'P2P_DP_USER';");
                                            }
                                        })
                                    ]
                                }).addStyleClass("sapUiTinyMarginTop"),
                                
                                // SQL Editor with proper label
                                new sap.m.Label({ 
                                    text: "SQL Query:",
                                    labelFor: "sqlEditor"
                                }).addStyleClass("sapUiTinyMarginTop"),
                                new sap.m.TextArea({
                                    id: "sqlEditor",
                                    value: "{/sqlQuery}",
                                    rows: 10,
                                    width: "100%",
                                    placeholder: "Enter SQL query here...",
                                    valueLiveUpdate: true
                                }).addStyleClass("sapUiTinyMarginTop"),
                                
                                // Results panel
                                new sap.m.Panel({
                                    headerText: "Query Results ({/queryResults/length} rows)",
                                    visible: "{= ${/queryResults}.length > 0}",
                                    content: [
                                        new sap.m.MessageStrip({
                                            text: "Query executed successfully in {/executionTime}ms",
                                            type: "Success",
                                            showIcon: true
                                        }).addStyleClass("sapUiTinyMarginBottom"),
                                        new sap.m.Text({
                                            text: "Showing first 100 rows. Use Data Products tab to view full table data."
                                        })
                                    ]
                                }).addStyleClass("sapUiSmallMarginTop")
                            ]
                        }).addStyleClass("sapUiContentPadding")
                    ]
                });
            }

            // Open Product Detail Dialog (Master-Detail Pattern)
            async function openProductDetailDialog(oProduct) {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    const source = oModel.getProperty("/selectedDataSource");
                    // Load tables for this product
                    const result = await dataProductsAPI.getTables(oProduct.schemaName, source);
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || "Failed to load tables");
                    }
                    
                    const tables = result.tables || [];
                    
                    // Create detail dialog with Object Page layout
                    const oDialog = new sap.m.Dialog({
                        title: oProduct.displayName || oProduct.productName,
                        contentWidth: "80%",
                        contentHeight: "80%",
                        resizable: true,
                        draggable: true,
                        verticalScrolling: false,
                        content: [
                            new sap.uxap.ObjectPageLayout({
                                showTitleInHeaderContent: true,
                                headerTitle: new sap.uxap.ObjectPageHeader({
                                    objectTitle: oProduct.displayName || oProduct.productName,
                                    objectSubtitle: oProduct.namespace,
                                    actions: [
                                        new sap.m.Button({
                                            text: "Refresh",
                                            icon: "sap-icon://refresh",
                                            press: function() {
                                                oDialog.close();
                                                openProductDetailDialog(oProduct);
                                            }
                                        }),
                                        new sap.m.Button({
                                            text: "View CSN",
                                            icon: "sap-icon://document-text",
                                            type: "Transparent",
                                            press: async function() {
                                                await showCSNViewer(oProduct);
                                            }
                                        })
                                    ],
                                    breadcrumbs: new sap.m.Breadcrumbs({
                                        links: [
                                            new sap.m.Link({
                                                text: "Data Products",
                                                press: function() {
                                                    oDialog.close();
                                                }
                                            })
                                        ],
                                        currentLocationText: oProduct.productName
                                    })
                                }),
                                headerContent: [
                                    new sap.m.ObjectAttribute({
                                        title: "Version",
                                        text: oProduct.version
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Schema",
                                        text: oProduct.schemaName
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Tables",
                                        text: tables.length + " tables"
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Created",
                                        text: oProduct.createTime || "N/A"
                                    })
                                ],
                                sections: [
                                    new sap.uxap.ObjectPageSection({
                                        title: "Tables",
                                        subSections: [
                                            new sap.uxap.ObjectPageSubSection({
                                                blocks: [
                                                    new sap.m.Table({
                                                        mode: "None",
                                                        columns: [
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Table Name" })
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Type" }),
                                                                hAlign: "Center",
                                                                width: "120px"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Records" }),
                                                                hAlign: "End",
                                                                width: "120px"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Actions" }),
                                                                hAlign: "Center",
                                                                width: "250px"
                                                            })
                                                        ],
                                                        items: tables.map(function(table) {
                                                            return new sap.m.ColumnListItem({
                                                                cells: [
                                                                    new sap.m.ObjectIdentifier({
                                                                        title: table.TABLE_NAME,
                                                                        titleActive: false
                                                                    }),
                                                                    new sap.m.ObjectStatus({
                                                                        text: table.TABLE_TYPE,
                                                                        state: "Information"
                                                                    }),
                                                                    new sap.m.ObjectNumber({
                                                                        number: (table.RECORD_COUNT || 0).toLocaleString(),
                                                                        emphasized: table.RECORD_COUNT > 0
                                                                    }),
                                                                    new sap.m.HBox({
                                                                        justifyContent: "Center",
                                                                        items: [
                                                                            new sap.m.Button({
                                                                                text: "Structure",
                                                                                icon: "sap-icon://table-view",
                                                                                press: async function() {
                                                                                    try {
                                                                                        await showTableStructure(oProduct.schemaName, table.TABLE_NAME, oDialog);
                                                                                    } catch (error) {
                                                                                        console.error('[CRITICAL] Structure button error:', error);
                                                                                        sap.m.MessageBox.error("Failed to open structure: " + error.message);
                                                                                    }
                                                                                }
                                                                            }),
                                                                            new sap.m.Button({
                                                                                text: "View Data",
                                                                                icon: "sap-icon://database",
                                                                                type: "Emphasized",
                                                                                press: function() {
                                                                                    showTableData(oProduct.schemaName, table.TABLE_NAME, table.RECORD_COUNT, oDialog);
                                                                                }
                                                                            }).addStyleClass("sapUiTinyMarginBegin")
                                                                        ]
                                                                    })
                                                                ]
                                                            });
                                                        })
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oDialog.destroy();
                            // Deselect table row to allow re-selection of same product
                            var oTable = sap.ui.getCore().byId("dataProductsTable");
                            if (oTable) {
                                oTable.removeSelections(true);
                            }
                        }
                    });
                    
                    oDialog.open();
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error loading product details: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Show Table Structure
            async function showTableStructure(schema, table, parentDialog) {
                const source = oModel.getProperty("/selectedDataSource");
                const startTime = debugLogger.entry('showTableStructure', { schema, table, source });
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log(`Calling getTableStructure API (source: ${source})`);
                    const result = await dataProductsAPI.getTableStructure(schema, table, source);
                    debugLogger.inspect('API Result', result);
                    
                    if (!result || !result.success) {
                        const errorMsg = result?.error?.message || "Failed to load structure";
                        throw new Error(errorMsg);
                    }
                    
                    const columns = result.columns || [];
                    debugLogger.log(`Found ${columns.length} columns`);
                    debugLogger.table('First 3 Columns', columns.slice(0, 3));
                    
                    const oStructureDialog = new sap.m.Dialog({
                        title: "Structure: " + table,
                        contentWidth: "70%",
                        contentHeight: "70%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.Table({
                                columns: [
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Column" }), width: "30%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Data Type" }), width: "25%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Length" }), hAlign: "End", width: "15%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Nullable" }), hAlign: "Center", width: "15%" }),
                                    new sap.m.Column({ header: new sap.m.Label({ text: "Key" }), hAlign: "Center", width: "15%" })
                                ],
                                items: columns.map(function(col) {
                                    return new sap.m.ColumnListItem({
                                        cells: [
                                            new sap.m.Text({ text: col.name || col.COLUMN_NAME }),
                                            new sap.m.Text({ text: col.dataType || col.DATA_TYPE_NAME }),
                                            new sap.m.Text({ text: col.length || col.LENGTH || "N/A" }),
                                            new sap.m.ObjectStatus({
                                                text: (col.nullable !== undefined ? col.nullable : col.IS_NULLABLE) ? "Yes" : "No",
                                                state: (col.nullable !== undefined ? col.nullable : col.IS_NULLABLE) ? "Warning" : "Success"
                                            }),
                                            new sap.m.Text({
                                                text: (col.isPrimaryKey || col.IS_PRIMARY_KEY) ? "ðŸ”‘" : ""
                                            })
                                        ]
                                    });
                                })
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oStructureDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oStructureDialog.destroy();
                        }
                    });
                    
                    oStructureDialog.open();
                    debugLogger.exit('showTableStructure', { dialogOpened: true }, startTime);
                    
                } catch (error) {
                    debugLogger.error('showTableStructure', error);
                    const errorMsg = error?.message || error?.error?.message || String(error);
                    sap.m.MessageBox.error("Error loading table structure: " + errorMsg);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Show Table Data
            async function showTableData(schema, table, recordCount, parentDialog) {
                const source = oModel.getProperty("/selectedDataSource");
                const startTime = debugLogger.entry('showTableData', { schema, table, recordCount, source });
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log(`Calling queryTable API (source: ${source})`);
                    const result = await dataProductsAPI.queryTable(schema, table, { limit: 100, offset: 0 }, source);
                    debugLogger.inspect('Query Result', result);
                    
                    if (!result || !result.success) {
                        const errorMsg = result?.error?.message || "Failed to load data";
                        throw new Error(errorMsg);
                    }
                    
                    const rows = result.rows || [];
                    const columns = result.columns || [];
                    const totalCount = result.totalCount || recordCount || 0;
                    
                    // Create table columns dynamically
                    const tableColumns = columns.map(function(col) {
                        return new sap.m.Column({
                            header: new sap.m.Label({ text: col.name }),
                            minScreenWidth: "Tablet",
                            demandPopin: true
                        });
                    });
                    
                    // Create table items
                    const tableItems = rows.map(function(row) {
                        const cells = columns.map(function(col) {
                            const value = row[col.name];
                            return new sap.m.Text({
                                text: value === null ? "NULL" : String(value)
                            });
                        });
                        
                        return new sap.m.ColumnListItem({
                            cells: cells
                        });
                    });
                    
                    const oDataDialog = new sap.m.Dialog({
                        title: "Data: " + table,
                        contentWidth: "90%",
                        contentHeight: "80%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.VBox({
                                items: [
                                    new sap.m.MessageStrip({
                                        text: "Showing " + rows.length + " of " + totalCount.toLocaleString() + " records â€¢ " + columns.length + " columns displayed â€¢ Execution: " + result.executionTime + "ms",
                                        type: "Information",
                                        showIcon: true
                                    }).addStyleClass("sapUiTinyMarginBottom"),
                                    new sap.m.MessageStrip({
                                        text: "Note: Displaying first 10 essential columns for readability. Use 'Structure' button to view all columns.",
                                        type: "Warning",
                                        showIcon: true,
                                        visible: columns.length >= 10
                                    }).addStyleClass("sapUiTinyMarginBottom"),
                                    new sap.m.Table({
                                        columns: tableColumns,
                                        items: tableItems,
                                        growing: false
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oDataDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oDataDialog.destroy();
                        }
                    });
                    
                    oDataDialog.open();
                    debugLogger.exit('showTableData', { rowsDisplayed: rows.length }, startTime);
                    
                } catch (error) {
                    debugLogger.error('showTableData', error);
                    sap.m.MessageBox.error("Error loading table data: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Show CSN Viewer Dialog
            async function showCSNViewer(oProduct) {
                const startTime = debugLogger.entry('showCSNViewer', { product: oProduct.productName });
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log('Fetching CSN definition from API');
                    
                    // Fetch CSN from backend
                    const result = await dataProductsAPI.getCSNDefinition(oProduct.schemaName);
                    debugLogger.inspect('CSN Result', result);
                    
                    if (!result || !result.success) {
                        const errorMsg = result?.error?.message || "CSN definition not available";
                        throw new Error(errorMsg);
                    }
                    
                    // Parse entities from CSN
                    const entities = dataProductsAPI.parseCSNEntities(result.csn);
                    debugLogger.log(`Parsed ${entities.length} entities`);
                    
                    if (entities.length === 0) {
                        throw new Error("No entities found in CSN definition");
                    }
                    
                    // Calculate totals
                    const totalFields = entities.reduce((sum, e) => sum + e.fieldCount, 0);
                    
                    // Create CSN viewer dialog
                    const oCSNDialog = new sap.m.Dialog({
                        title: "CSN Definition: " + (oProduct.displayName || oProduct.productName),
                        contentWidth: "85%",
                        contentHeight: "85%",
                        resizable: true,
                        draggable: true,
                        verticalScrolling: true,
                        content: [
                            new sap.m.VBox({
                                items: [
                                    // Info header
                                    new sap.m.MessageStrip({
                                        text: `Core Schema Notation (CSN) â€¢ ${entities.length} entities â€¢ ${totalFields} total fields â€¢ Source: ${result.source}`,
                                        type: "Information",
                                        showIcon: true
                                    }).addStyleClass("sapUiTinyMarginBottom"),
                                    
                                    // Entity panels
                                    new sap.m.VBox({
                                        items: entities.map(function(entity) {
                                            // Format all fields in this entity
                                            const fields = [];
                                            for (const [fieldName, fieldDef] of Object.entries(entity.elements)) {
                                                const formatted = dataProductsAPI.formatCSNField(fieldName, fieldDef);
                                                fields.push(formatted);
                                            }
                                            
                                            // Sort: keys first, then alphabetically
                                            fields.sort((a, b) => {
                                                if (a.key && !b.key) return -1;
                                                if (!a.key && b.key) return 1;
                                                return a.name.localeCompare(b.name);
                                            });
                                            
                                            return new sap.m.Panel({
                                                headerText: `ðŸ“¦ ${entity.name} (${entity.fieldCount} fields)`,
                                                expandable: true,
                                                expanded: entity.name.includes('Supplier') && !entity.name.includes('Company'), // Expand main entity by default
                                                content: [
                                                    new sap.m.Table({
                                                        columns: [
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Field Name" }),
                                                                width: "25%"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Type" }),
                                                                width: "15%"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Length" }),
                                                                hAlign: "End",
                                                                width: "10%"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Key" }),
                                                                hAlign: "Center",
                                                                width: "8%"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Nullable" }),
                                                                hAlign: "Center",
                                                                width: "10%"
                                                            }),
                                                            new sap.m.Column({
                                                                header: new sap.m.Label({ text: "Description" }),
                                                                minScreenWidth: "Tablet",
                                                                demandPopin: true
                                                            })
                                                        ],
                                                        items: fields.map(function(field) {
                                                            // Format type with precision/scale if applicable
                                                            let typeDisplay = field.type.replace('cds.', '');
                                                            if (field.precision && field.scale) {
                                                                typeDisplay += ` (${field.precision},${field.scale})`;
                                                            }
                                                            
                                                            return new sap.m.ColumnListItem({
                                                                cells: [
                                                                    new sap.m.Text({
                                                                        text: field.name,
                                                                        wrapping: false
                                                                    }),
                                                                    new sap.m.Text({
                                                                        text: typeDisplay
                                                                    }),
                                                                    new sap.m.Text({
                                                                        text: field.length !== null ? String(field.length) : "â€”"
                                                                    }),
                                                                    new sap.m.Text({
                                                                        text: field.key ? "ðŸ”‘" : ""
                                                                    }),
                                                                    new sap.m.ObjectStatus({
                                                                        text: field.nullable ? "Yes" : "No",
                                                                        state: field.nullable ? "Warning" : "Success"
                                                                    }),
                                                                    new sap.m.Text({
                                                                        text: field.description,
                                                                        wrapping: true
                                                                    })
                                                                ]
                                                            });
                                                        })
                                                    })
                                                ]
                                            }).addStyleClass("sapUiTinyMarginBottom");
                                        })
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Copy to Clipboard",
                            icon: "sap-icon://copy",
                            press: function() {
                                const csnText = JSON.stringify(result.csn, null, 2);
                                navigator.clipboard.writeText(csnText).then(function() {
                                    sap.m.MessageToast.show("CSN copied to clipboard");
                                }).catch(function(err) {
                                    sap.m.MessageBox.error("Failed to copy: " + err.message);
                                });
                            }
                        }),
                        endButton: new sap.m.Button({
                            text: "Download JSON",
                            icon: "sap-icon://download",
                            press: function() {
                                const csnText = JSON.stringify(result.csn, null, 2);
                                const blob = new Blob([csnText], { type: 'application/json' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `${oProduct.productName}-csn-${new Date().toISOString().split('T')[0]}.json`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                                sap.m.MessageToast.show("CSN downloaded");
                            }
                        }),
                        buttons: [
                            new sap.m.Button({
                                text: "Close",
                                press: function() {
                                    oCSNDialog.close();
                                }
                            })
                        ],
                        afterClose: function() {
                            oCSNDialog.destroy();
                        }
                    });
                    
                    oCSNDialog.open();
                    debugLogger.exit('showCSNViewer', { entities: entities.length, fields: totalFields }, startTime);
                    
                } catch (error) {
                    debugLogger.error('showCSNViewer', error);
                    sap.m.MessageBox.error("Error loading CSN definition: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Open Feature Manager Dialog
            async function openFeatureManagerDialog() {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    // Fetch features from API
                    const response = await fetch("/api/features");
                    const data = await response.json();
                    
                    if (!data || !data.success) {
                        throw new Error(data?.error || "Failed to load features");
                    }
                    
                    // Handle nested structure
                    const featuresObj = data.features.features || data.features;
                    const allFeatures = featuresObj;
                    
                    // Group features by category
                    const categories = {};
                    for (const [key, feature] of Object.entries(allFeatures)) {
                        const category = feature.category || "Uncategorized";
                        if (!categories[category]) {
                            categories[category] = [];
                        }
                        categories[category].push({ key, ...feature });
                    }
                    
                    // Create IconTabBar with categories
                    const oIconTabBar = new sap.m.IconTabBar({
                        expandable: false,
                        items: []
                    });
                    
                    // Icon mapping
                    const iconMap = {
                        "All": "sap-icon://list",
                        "Infrastructure": "sap-icon://settings",
                        "Business Logic": "sap-icon://business-objects-experience",
                        "Developer Tools": "sap-icon://wrench",
                        "Demo/Testing": "sap-icon://lab"
                    };
                    
                    // Add "All Features" tab
                    const allFeaturesList = Object.entries(allFeatures).map(([key, feature]) => ({ key, ...feature }));
                    oIconTabBar.addItem(createFeatureTab("All", allFeaturesList, iconMap, allFeatures));
                    
                    // Add category tabs
                    for (const [category, features] of Object.entries(categories)) {
                        oIconTabBar.addItem(createFeatureTab(category, features, iconMap, allFeatures));
                    }
                    
                    // Create Feature Manager dialog
                    const oFMDialog = new sap.m.Dialog({
                        title: "Feature Manager",
                        contentWidth: "70%",
                        contentHeight: "80%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.VBox({
                                items: [
                                    new sap.m.MessageStrip({
                                        text: "Enable or disable modules to customize your application. Changes take effect immediately.",
                                        type: "Information",
                                        showIcon: true
                                    }).addStyleClass("sapUiTinyMarginBottom"),
                                    oIconTabBar
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oFMDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oFMDialog.destroy();
                        }
                    });
                    
                    oFMDialog.open();
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error loading Feature Manager: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }
            
            // Helper: Create feature tab
            function createFeatureTab(categoryName, features, iconMap, allFeatures) {
                const oList = new sap.m.List({
                    headerText: categoryName === "All" ? "All Features" : categoryName + " Features",
                    mode: "None"
                });
                
                // FEATURE FLAG: Switch between InputListItem and CustomListItem
                // Set to true to use CustomListItem (Fiori-recommended for settings)
                // Set to false to use InputListItem (current implementation)
                const USE_CUSTOM_LIST_ITEM = false;
                
                // Add features to list
                features.forEach(feature => {
                    const oSwitch = new sap.m.Switch({
                        state: feature.enabled || false,
                        customTextOn: "ON",
                        customTextOff: "OFF",
                        tooltip: "Toggle " + (feature.displayName || feature.key),
                        change: async function(oEvent) {
                            const bState = oEvent.getParameter("state");
                            // Find the dialog by traversing up from the switch
                            let oDialog = oSwitch.getParent();
                            while (oDialog && oDialog.getMetadata().getName() !== "sap.m.Dialog") {
                                oDialog = oDialog.getParent();
                            }
                            await toggleFeatureInDialog(feature.key, feature.displayName, bState, oSwitch, oDialog);
                        }
                    });
                    
                    // Store feature key in custom data for reliable identification
                    oSwitch.data("featureKey", feature.key);
                    
                    let oListItem;
                    
                    if (USE_CUSTOM_LIST_ITEM) {
                        // âœ… CORRECT: CustomListItem for settings with toggles
                        // Fiori-recommended pattern for custom layouts
                        oListItem = new sap.m.CustomListItem({
                            content: [
                                new sap.m.HBox({
                                    justifyContent: "SpaceBetween",
                                    width: "100%",
                                    alignItems: "Center",
                                    items: [
                                        // Left: Feature info
                                        new sap.m.VBox({
                                            items: [
                                                new sap.m.Label({
                                                    text: feature.displayName || feature.key
                                                }).addStyleClass("sapUiTinyMarginBottom"),
                                                new sap.m.Text({
                                                    text: feature.description || "No description"
                                                })
                                            ]
                                        }),
                                        // Right: Toggle switch
                                        oSwitch
                                    ]
                                })
                            ]
                        });
                    } else {
                        // âš ï¸ ALTERNATIVE: InputListItem (designed for input fields, not switches)
                        // Note: InputListItem is for "label + input field" forms, not settings
                        oListItem = new sap.m.InputListItem({
                            label: feature.displayName || feature.key,
                            content: [oSwitch]
                        });
                        
                        // Add description as tooltip
                        if (feature.description) {
                            oListItem.setTooltip(feature.description);
                        }
                    }
                    
                    oList.addItem(oListItem);
                });
                
                return new sap.m.IconTabFilter({
                    text: categoryName,
                    key: categoryName,
                    icon: iconMap[categoryName] || "sap-icon://list",
                    content: [oList]
                });
            }
            
            // Helper: Toggle feature in dialog
            async function toggleFeatureInDialog(key, name, state, oSwitch, oDialog) {
                oSwitch.setBusy(true);
                
                try {
                    const response = await fetch(`/api/features/${key}/toggle`, {
                        method: "POST"
                    });
                    const data = await response.json();
                    
                    if (data && data.success) {
                        sap.m.MessageToast.show(`${name} ${data.enabled ? "enabled" : "disabled"} successfully`);
                        
                        // SYNC FIX: Update ALL switches across ALL tabs
                        syncAllSwitchesInDialog(oDialog, key, data.enabled);
                    } else {
                        const errorMsg = (data && data.error) ? data.error : "Unknown error";
                        sap.m.MessageToast.show(`Failed to toggle ${name}: ${errorMsg}`);
                        // Revert switch
                        oSwitch.setState(!state);
                    }
                } catch (error) {
                    sap.m.MessageToast.show(`Error toggling ${name}: ${error.message}`);
                    // Revert switch
                    oSwitch.setState(!state);
                } finally {
                    oSwitch.setBusy(false);
                }
            }
            
            // Helper: Sync all switches across all tabs after toggle
            function syncAllSwitchesInDialog(oDialog, featureKey, newState) {
                if (!oDialog) {
                    console.warn('[FeatureManager] Cannot sync: dialog reference not found');
                    return;
                }
                
                // Find the IconTabBar in the dialog
                const oDialogContent = oDialog.getContent()[0]; // VBox
                const oIconTabBar = oDialogContent.getItems()[1]; // IconTabBar (after MessageStrip)
                
                if (!oIconTabBar) {
                    console.warn('[FeatureManager] Cannot sync: IconTabBar not found');
                    return;
                }
                
                // Iterate through ALL tabs
                const aTabs = oIconTabBar.getItems();
                aTabs.forEach(function(oTab) {
                    // Get the list in this tab
                    const oList = oTab.getContent()[0];
                    if (!oList) return;
                    
                    // Iterate through all list items
                    const aItems = oList.getItems();
                    aItems.forEach(function(oItem) {
                        // Get the switch from the item
                        let oSwitch;
                        
                        if (oItem.getMetadata().getName() === "sap.m.InputListItem") {
                            // InputListItem: switch is in content array
                            const aContent = oItem.getContent();
                            if (aContent && aContent.length > 0) {
                                oSwitch = aContent[0];
                            }
                        } else if (oItem.getMetadata().getName() === "sap.m.CustomListItem") {
                            // CustomListItem: switch is nested in HBox
                            const oHBox = oItem.getContent()[0];
                            if (oHBox) {
                                const aHBoxItems = oHBox.getItems();
                                oSwitch = aHBoxItems[aHBoxItems.length - 1]; // Last item is switch
                            }
                        }
                        
                        // Update switch state if it matches the feature key (using custom data)
                        if (oSwitch && oSwitch.getMetadata().getName() === "sap.m.Switch") {
                            const switchFeatureKey = oSwitch.data("featureKey");
                            if (switchFeatureKey === featureKey) {
                                // Only update if state actually changed (avoid triggering change event)
                                if (oSwitch.getState() !== newState) {
                                    oSwitch.setState(newState);
                                }
                            }
                        }
                    });
                });
            }

            // Load data products from selected source
            async function loadDataProducts() {
                const source = oModel.getProperty("/selectedDataSource");
                const startTime = debugLogger.entry('loadDataProducts', { source });
                oModel.setProperty("/loading", true);
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    debugLogger.log(`Calling listDataProducts API (source: ${source})`);
                    const result = await dataProductsAPI.listDataProducts(source);
                    debugLogger.inspect('List Result', result);
                    
                    if (result.success) {
                        oModel.setProperty("/dataProducts", result.dataProducts);
                        const srcName = source === 'sqlite' ? 'SQLite' : 'HANA Cloud';
                        sap.m.MessageToast.show(`Loaded ${result.count} data products from ${srcName}`);
                        debugLogger.exit('loadDataProducts', { count: result.count, source }, startTime);
                    } else {
                        const srcName = source === 'sqlite' ? 'SQLite' : 'HANA Cloud';
                        sap.m.MessageBox.error(`Failed to load from ${srcName}: ` + 
                            (result.error ? result.error.message : "Unknown error"));
                    }
                } catch (error) {
                    debugLogger.error('loadDataProducts', error);
                    sap.m.MessageBox.error("Connection Error", {
                        details: error.message
                    });
                } finally {
                    oModel.setProperty("/loading", false);
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Open Log Viewer Dialog
            async function openLogViewerDialog() {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    // Fetch logs from API
                    const result = await logViewerAPI.getLogs({ limit: 100 });
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || "Failed to load logs");
                    }
                    
                    const logs = result.logs || [];
                    
                    // Calculate statistics from logs
                    const stats = {
                        total: logs.length,
                        INFO: logs.filter(l => l.level === 'INFO').length,
                        WARNING: logs.filter(l => l.level === 'WARNING').length,
                        ERROR: logs.filter(l => l.level === 'ERROR').length
                    };
                    
                    // Create log viewer dialog
                    const oLogDialog = new sap.m.Dialog({
                        title: "Application Logs",
                        contentWidth: "80%",
                        contentHeight: "70%",
                        resizable: true,
                        draggable: true,
                        content: [
                            new sap.m.VBox({
                                items: [
                                    // Toolbar with filters and actions
                                    new sap.m.OverflowToolbar({
                                        content: [
                                            new sap.m.Title({
                                                text: "Logs (" + logs.length + ")",
                                                level: "H2"
                                            }),
                                            new sap.m.ToolbarSpacer(),
                                            new sap.m.Label({
                                                text: "Filter:"
                                            }),
                                            new sap.m.SegmentedButton({
                                                selectedKey: "ALL",
                                                selectionChange: async function(oEvent) {
                                                    const level = oEvent.getParameter("item").getKey();
                                                    await refreshLogs(oLogDialog, level);
                                                },
                                                items: [
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "ALL",
                                                        text: "All (" + (stats.total || 0) + ")"
                                                    }),
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "INFO",
                                                        text: "Info (" + (stats.INFO || 0) + ")"
                                                    }),
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "WARNING",
                                                        text: "Warning (" + (stats.WARNING || 0) + ")"
                                                    }),
                                                    new sap.m.SegmentedButtonItem({
                                                        key: "ERROR",
                                                        text: "Error (" + (stats.ERROR || 0) + ")"
                                                    })
                                                ]
                                            }),
                                            new sap.m.Button({
                                                icon: "sap-icon://refresh",
                                                tooltip: "Refresh",
                                                press: async function() {
                                                    await refreshLogs(oLogDialog, "ALL");
                                                }
                                            }),
                                            new sap.m.Button({
                                                icon: "sap-icon://delete",
                                                tooltip: "Clear Logs",
                                                press: async function() {
                                                    sap.m.MessageBox.confirm("Are you sure you want to clear all logs?", {
                                                        onClose: async function(oAction) {
                                                            if (oAction === sap.m.MessageBox.Action.OK) {
                                                                await logViewerAPI.clearLogs();
                                                                await refreshLogs(oLogDialog, "ALL");
                                                                sap.m.MessageToast.show("Logs cleared");
                                                            }
                                                        }
                                                    });
                                                }
                                            }),
                                            new sap.m.Button({
                                                id: "debugModeButton",
                                                text: debugLogger.isEnabled() ? "ðŸ› Debug Mode: ON" : "ðŸ› Debug Mode: OFF",
                                                type: debugLogger.isEnabled() ? "Emphasized" : "Default",
                                                tooltip: "Toggle debug mode for detailed troubleshooting logs",
                                                press: function() {
                                                    const newState = debugLogger.toggle();
                                                    const oButton = sap.ui.getCore().byId("debugModeButton");
                                                    if (oButton) {
                                                        oButton.setText(newState ? "ðŸ› Debug Mode: ON" : "ðŸ› Debug Mode: OFF");
                                                        oButton.setType(newState ? "Emphasized" : "Default");
                                                    }
                                                    sap.m.MessageToast.show(
                                                        newState ? 
                                                        "Debug Mode enabled - All function calls will be logged in console" :
                                                        "Debug Mode disabled"
                                                    );
                                                }
                                            })
                                        ]
                                    }),
                                    
                                    // Logs table
                                    new sap.m.Table({
                                        id: "logsTable",
                                        growing: true,
                                        growingThreshold: 50,
                                        noDataText: "No logs available",
                                        columns: [
                                            new sap.m.Column({
                                                header: new sap.m.Label({ text: "Time" }),
                                                width: "160px",
                                                minScreenWidth: "Tablet",
                                                demandPopin: false
                                            }),
                                            new sap.m.Column({
                                                header: new sap.m.Label({ text: "Level" }),
                                                width: "100px",
                                                hAlign: "Center"
                                            }),
                                            new sap.m.Column({
                                                header: new sap.m.Label({ text: "Message" }),
                                                minScreenWidth: "Tablet",
                                                demandPopin: true
                                            })
                                        ],
                                        items: logs.map(function(log) {
                                            // Determine color based on level
                                            let state = "None";
                                            let icon = "sap-icon://message-information";
                                            
                                            if (log.level === "ERROR") {
                                                state = "Error";
                                                icon = "sap-icon://message-error";
                                            } else if (log.level === "WARNING") {
                                                state = "Warning";
                                                icon = "sap-icon://message-warning";
                                            } else if (log.level === "INFO") {
                                                state = "Information";
                                                icon = "sap-icon://message-information";
                                            }
                                            
                                            return new sap.m.ColumnListItem({
                                                cells: [
                                                    new sap.m.Text({
                                                        text: logViewerAPI.formatTimestamp(log.timestamp)
                                                    }),
                                                    new sap.m.ObjectStatus({
                                                        text: log.level,
                                                        state: state,
                                                        icon: icon
                                                    }),
                                                    new sap.m.Text({
                                                        text: log.message,
                                                        wrapping: true
                                                    })
                                                ]
                                            });
                                        })
                                    })
                                ]
                            })
                        ],
                        beginButton: new sap.m.Button({
                            text: "Close",
                            press: function() {
                                oLogDialog.close();
                            }
                        }),
                        afterClose: function() {
                            oLogDialog.destroy();
                        }
                    });
                    
                    oLogDialog.open();
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error loading logs: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }
            
            // Refresh logs in dialog
            async function refreshLogs(oDialog, level) {
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    const fetchLevel = (level === 'ALL') ? null : level;
                    const result = await logViewerAPI.getLogs({ level: fetchLevel, limit: 100 });
                    
                    if (!result.success) {
                        throw new Error(result.error?.message || "Failed to refresh logs");
                    }
                    
                    const logs = result.logs || [];
                    
                    // Calculate statistics from logs
                    const stats = {
                        total: logs.length,
                        INFO: logs.filter(l => l.level === 'INFO').length,
                        WARNING: logs.filter(l => l.level === 'WARNING').length,
                        ERROR: logs.filter(l => l.level === 'ERROR').length
                    };
                    
                    // Update table
                    const oTable = sap.ui.getCore().byId("logsTable");
                    if (oTable) {
                        oTable.destroyItems();
                        
                        logs.forEach(function(log) {
                            let state = "None";
                            let icon = "sap-icon://message-information";
                            
                            if (log.level === "ERROR") {
                                state = "Error";
                                icon = "sap-icon://message-error";
                            } else if (log.level === "WARNING") {
                                state = "Warning";
                                icon = "sap-icon://message-warning";
                            } else if (log.level === "INFO") {
                                state = "Information";
                                icon = "sap-icon://message-information";
                            }
                            
                            oTable.addItem(new sap.m.ColumnListItem({
                                cells: [
                                    new sap.m.Text({
                                        text: logViewerAPI.formatTimestamp(log.timestamp)
                                    }),
                                    new sap.m.ObjectStatus({
                                        text: log.level,
                                        state: state,
                                        icon: icon
                                    }),
                                    new sap.m.Text({
                                        text: log.message,
                                        wrapping: true
                                    })
                                ]
                            }));
                        });
                    }
                    
                    sap.m.MessageToast.show("Logs refreshed (" + logs.length + " entries)");
                    
                } catch (error) {
                    sap.m.MessageBox.error("Error refreshing logs: " + error.message);
                } finally {
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Execute SQL
            async function executeSQL() {
                const sql = oModel.getProperty("/sqlQuery");
                const instanceId = oModel.getProperty("/selectedInstance");
                
                if (!instanceId) {
                    sap.m.MessageBox.warning("Please select a HANA instance");
                    return;
                }
                
                oModel.setProperty("/executing", true);
                sap.ui.core.BusyIndicator.show(0);
                
                try {
                    const result = await sqlExecutionAPI.executeQuery(instanceId, sql);
                    
                    if (result.success) {
                        oModel.setProperty("/queryResults", result.rows || []);
                        oModel.setProperty("/executionTime", result.executionTime);
                        sap.m.MessageToast.show(`Query executed: ${result.rowCount} rows in ${result.executionTime}ms`);
                    } else {
                        sap.m.MessageBox.error("Query Failed", {
                            details: result.error.message
                        });
                    }
                } catch (error) {
                    sap.m.MessageBox.error("Execution Error", {
                        details: error.message
                    });
                } finally {
                    oModel.setProperty("/executing", false);
                    sap.ui.core.BusyIndicator.hide();
                }
            }

            // Set model and render
            oApp.setModel(oModel);
            oApp.placeAt("content");
            
            // Load initial data
            (async function() {
                try {
                    // Load HANA instances
                    const instances = await hanaConnectionAPI.getInstances();
                    oModel.setProperty("/hanaInstances", instances);
                    if (instances.length > 0) {
                        oModel.setProperty("/selectedInstance", instances[0].id);
                    }
                    
                    // Auto-load data products
                    await loadDataProducts();
                } catch (error) {
                    console.error("Initialization error:", error);
                }
            })();
        });
    </script>
</head>
<body class="sapUiBody" id="content">
    <div class="sapUiSizeCompact"></div>
</body>
</html>
