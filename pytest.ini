[pytest]
# ============================================================================
# Gu Wu (顾武) Testing Framework - Self-Healing Test Configuration
# ============================================================================
# "Attending to martial affairs with discipline and continuous improvement"
#
# Philosophy: Like Feng Shui auto-corrects code organization, Gu Wu auto-
# optimizes test execution, prioritization, and quality over time through
# self-learning and reflection.
# ============================================================================

# Python Path Configuration (CRITICAL: Must be set before test discovery)
# Note: On Windows, pytest may need explicit path. conftest.py also adds to sys.path as backup.
pythonpath = .

# Test Discovery
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Output Configuration
console_output_style = progress
addopts =
    # Coverage Settings
    --cov=modules
    --cov=core
    --cov-report=html:tests/htmlcov
    --cov-report=term-missing:skip-covered
    --cov-report=xml:tests/coverage.xml
    --cov-report=json:tools/guwu/coverage.json
    --cov-branch
    --cov-fail-under=70
    
    # Test Execution
    --verbose
    --tb=short
    --strict-markers
    --strict-config
    
    # Performance Tracking
    --durations=10
    --durations-min=0.1
    
    # Note: Gu Wu self-optimization is enabled via conftest.py hooks
    # Custom flags will be added in Phase 2 with proper pytest plugin
    
    # Parallel Execution (Phase 2)
    # -n auto
    # --dist=loadscope

# Test Markers (for categorization and selective execution)
markers =
    # Test Pyramid Layers
    unit: Unit tests (fast, isolated, 70% of suite)
    integration: Integration tests (module interactions, 20% of suite)
    e2e: End-to-end tests (full workflows, 10% of suite)
    
    # Performance Characteristics
    slow: Tests that take > 1 second
    fast: Tests that take < 0.1 seconds
    
    # Functional Categories
    security: Security-related tests
    performance: Performance/load tests
    smoke: Smoke tests for quick validation
    regression: Regression tests for bug prevention
    
    # Gu Wu Auto-Learning Markers
    flaky: Tests identified as flaky by Gu Wu
    critical: Critical path tests (never skip)
    optimized: Tests optimized by Gu Wu
    baseline: Baseline tests for Gu Wu learning

# Minimum Python Version
minversion = 3.8

# Test Timeout (prevent hanging tests)
timeout = 300
timeout_method = thread

# Warnings
filterwarnings =
    error
    ignore::UserWarning
    ignore::DeprecationWarning

# Logging
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = tools/guwu/pytest.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)8s] [%(filename)s:%(lineno)d] %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Gu Wu Framework Configuration
[guwu]
# Self-Optimization Settings
enabled = true
auto_prioritize = true
learn_from_failures = true
suggest_improvements = true

# Metrics Collection
metrics_db = tools/guwu/metrics.db
collect_timing = true
collect_coverage = true
collect_failures = true

# Self-Healing Thresholds
flaky_test_threshold = 3  # Mark as flaky after 3 intermittent failures
slow_test_threshold = 5.0  # Mark as slow if > 5 seconds
coverage_drop_threshold = 5  # Alert if coverage drops > 5%

# Auto-Adjustment
auto_parallelize_slow_tests = true
auto_skip_redundant_tests = false  # Phase 2
auto_reorder_by_failure_rate = true

# Reporting
generate_insights_report = true
insights_report_path = tools/guwu/insights.html
send_recommendations = true