# Development Standards & Best Practices

**Version**: 4.2  
**Last Updated**: 2026-02-15 (Gu Wu API Contract Testing Foundation)
**Purpose**: Core standards for P2P Data Products development

---

## âš ï¸ CRITICAL: GU WU API CONTRACT TESTING FOUNDATION

**CORE PRINCIPLE**: Test API contracts, not implementation details â­ FUNDAMENTAL

### The Breakthrough Insight (Feb 15, 2026)

> "The foundation of Gu Wu is to test the backend APIs and frontend APIs. 
> By testing consistently this API contract, you test implicitly all other 
> contributing functions without testing them explicitly."

**What This Means**:
- âœ… Test **Backend APIs**: Business logic endpoints (`/api/ai-assistant/chat`, `/api/data-products`)
- âœ… Test **Frontend APIs**: Metadata/configuration endpoints (`/api/modules/frontend-registry`)
- âœ… **ONE API test validates entire chain**: Controller â†’ Service â†’ Repository â†’ Database
- âŒ DON'T test every internal function explicitly (maintenance burden)
- âœ… DO trust implementation, test the public contract

**Why This Works**:
- **EFFICIENCY**: One API contract test exercises entire call stack implicitly
- **SPEED**: 60-300x faster than browser testing (< 1 second vs 60-300 seconds)
- **IMPLICIT COVERAGE**: API test automatically validates all contributing functions
- **EXAMPLE**: `POST /api/ai-assistant/chat` tests AgentService, ConversationRepository, Database implicitly

**Test Pyramid** (API-Focused):
```
10% E2E Tests         - Critical user workflows
20% Integration       - API contract tests â­ FOCUS HERE
70% Unit Tests        - Only for complex algorithms/utilities
```

**MANDATORY TESTING WORKFLOW**:

1. **Design API Contracts** (BEFORE implementation):
   - Define endpoints (method, path, purpose)
   - Define request/response schemas
   - Write contract tests with `@pytest.mark.api_contract`

2. **Implement APIs**:
   - Backend API (business logic)
   - Frontend API (metadata/configuration)
   
3. **Test APIs via requests** (< 1 second):
   ```python
   @pytest.mark.e2e
   @pytest.mark.api_contract
   def test_endpoint_contract():
       """Test: API returns valid contract structure"""
       response = requests.post(url, json=payload)
       assert response.status_code == 200
       assert 'success' in response.json()
   ```

4. **Verify APIs stable** (all contract tests passing)

5. **THEN build UX** (on stable API foundation)

**AI Enforcement** (MANDATORY):

Before implementing ANY feature, AI must ask in `<thinking>`:
1. â“ Have I designed the API endpoints?
2. â“ Have I written API contract tests?
3. â“ Have I tested APIs via requests/curl (< 1s)?
4. â“ Are all API contract tests passing?
5. â“ Am I about to build UX without stable APIs?

**If APIs not tested/stable**: STOP. Test APIs FIRST.

---

## ğŸ¯ PRIORITY 0: SAFETY CHECKPOINT

### 0. Clean Git State Before Critical Changes âš ï¸ MANDATORY

**RULE**: Before any risky operation, ensure clean git state with remote backup

**Critical Operations**:
- âœ… Architecture refactoring
- âœ… Database schema changes
- âœ… Build system changes
- âœ… Multi-file operations

**Safety Workflow**:
```bash
git status
git add .
git commit -m "checkpoint: [state]"
git push origin main
# Now safe to proceed
```

---

## ğŸ¯ PRIORITY 1: ESSENTIAL WORKFLOWS

### 1. Knowledge Graph First â­ MANDATORY

**Before ANY work**:
```xml
<use_mcp_tool>
  <server_name>github.com/modelcontextprotocol/servers/tree/main/src/memory</server_name>
  <tool_name>search_nodes</tool_name>
  <arguments>{"query": "[terms]"}</arguments>
</use_mcp_tool>
```

**At session end**: Store learnings with complete WHY context (8 elements: WHAT, WHY, PROBLEM, ALTERNATIVES, CONSTRAINTS, VALIDATION, WARNINGS, CONTEXT)

---

### 2. Knowledge Vault Documentation â­ MANDATORY

**ALL docs â†’ `docs/knowledge/` vault**
- âœ… Use [[wikilinks]] for cross-references
- âœ… Update `INDEX.md` with every doc
- âŒ No .md files outside vault (except .clinerules, PROJECT_TRACKER.md, README.md)

---

### 3. API-First Development â­ MANDATORY

**Order** (NO EXCEPTIONS):
1. âœ… Design API contracts (backend + frontend)
2. âœ… Write API contract tests (`@pytest.mark.api_contract`)
3. âœ… Implement APIs
4. âœ… **TEST APIs via curl/requests** (< 1 second) â­ CRITICAL
5. âœ… Verify all API tests passing
6. âœ… THEN build UX on stable foundation

**Why**:
- API bugs found during UX = rework both layers
- API testing 60-300x faster than browser testing
- Stable APIs = UX focuses on experience only

---

## ğŸ¯ PRIORITY 2: TESTING STANDARDS

### 4. Gu Wu API Contract Testing â­ CORE METHODOLOGY

**Philosophy**: "Test the contract, trust the implementation"

**What to Test** (API Contracts ONLY):

**âœ… REQUIRED - API Contract Tests**:
```python
@pytest.mark.e2e
@pytest.mark.api_contract
def test_backend_api_contract():
    """Test: Backend API returns valid contract"""
    # ARRANGE
    url = "http://localhost:5000/api/[module]/[endpoint]"
    
    # ACT
    response = requests.post(url, json=payload, timeout=5)
    
    # ASSERT
    assert response.status_code == 200
    assert 'success' in response.json()
    assert 'data' in response.json()

@pytest.mark.e2e
@pytest.mark.api_contract
def test_frontend_api_contract():
    """Test: Frontend API returns metadata"""
    # ARRANGE
    url = "http://localhost:5000/api/modules/frontend-registry"
    
    # ACT
    response = requests.get(url, timeout=5)
    
    # ASSERT
    data = response.json()
    assert 'modules' in data
    assert len(data['modules']) > 0
```

**âŒ NOT REQUIRED - Internal Function Tests**:
- âŒ Don't test `service.method()` explicitly (tested implicitly via API)
- âŒ Don't test `repository.query()` explicitly (tested implicitly via API)
- âŒ Don't test `database.execute()` explicitly (tested implicitly via API)
- âœ… DO test complex algorithms/utilities IF used outside API chain

**Why This Works**:
- One API test validates entire call chain automatically
- Internal refactoring doesn't break tests (only contracts matter)
- Maintenance burden reduced dramatically
- Tests stay green as long as API contract honored

**Test Structure**:
```
tests/
â”œâ”€â”€ test_[module]_backend_api.py      # Backend API contracts
â”œâ”€â”€ test_[module]_frontend_api.py     # Frontend API contracts
â”œâ”€â”€ test_smoke.py                      # Module import validation
â””â”€â”€ conftest.py                        # Shared fixtures
```

**AI Enforcement** (MANDATORY):

Before using `attempt_completion`, AI must ask in `<thinking>`:
1. â“ Have I written API contract tests?
2. â“ Have I run API tests via requests (< 1s)?
3. â“ Are all API contract tests passing?
4. â“ Am I testing implementation details unnecessarily?

**If testing internal functions**: Ask yourself: "Is this tested implicitly via API contract?"

---

### 5. Test Verification Protocol âš ï¸ CRITICAL

**MANDATORY SEQUENCE**:
1. âœ… Write API contract tests
2. âœ… Run: `pytest [test_file] -v`
3. âœ… WAIT for completion
4. âœ… Verify all green
5. âœ… THEN use `attempt_completion`

**FORBIDDEN**:
- âŒ Write tests â†’ attempt_completion (without running)
- âŒ Tests fail â†’ attempt_completion anyway

---

### 6. Browser Testing: AVOID âš ï¸

**RULE**: Use `browser_action` ONLY as last resort

**Correct Methods** (Try FIRST):
1. â­ **API Contract Testing**: `requests.get/post()` (< 1 second)
2. â­ **pytest**: Automated, fast, reliable
3. âŒ **Browser**: Only for final UX validation (after APIs stable)

**Key Insight**:
> Every UI activity maps to API call. Test the API first!

---

## ğŸ¯ PRIORITY 3: ARCHITECTURE & QUALITY

### 7. Feng Shui - Architecture Intelligence

**When to Use**:
```bash
# Comprehensive multi-agent analysis
python -m tools.fengshui analyze

# Autonomous batch fixes
python -m tools.fengshui fix

# Module quality gate
python -m tools.fengshui gate --module [name]
```

**Let Feng Shui handle** architecture repairs autonomously

---

### 8. Shi Fu - Quality Ecosystem

**Session Start Routine**:
```bash
python -m tools.shifu --session-start
```

Automatically checks ecosystem health, updates PROJECT_TRACKER.md with priorities

---

### 9. Modular Architecture

**Module Structure**:
```
modules/[name]/
â”œâ”€â”€ module.json
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ api.py          # Flask Blueprint
â”‚   â””â”€â”€ service.py
â””â”€â”€ README.md
```

**Validation**: Feng Shui quality gate

---

## ğŸ¯ PRIORITY 4: OPERATIONAL

### 10. Server Cleanup âš ï¸ MANDATORY

**Before `attempt_completion`**:
```bash
taskkill /F /IM python.exe  # Kill test servers
```

**NEVER** start servers via `<command>` in attempt_completion

---

### 11. Git Workflow

**AI Can Execute Git** ONLY when user explicitly requests:
- âœ… User says "git push with tag" â†’ AI executes
- âœ… Otherwise: AI stages, user commits/pushes

**Tag Handling**:
- âœ… If tag exists, increment version
- âŒ NEVER delete/force-push tags

---

### 12. Project Tracker

**PROJECT_TRACKER.md** (~150 lines):
- QUICK START, ACTIVE TASKS, VERSION HISTORY
- Git tags contain detailed implementation notes

---

## ğŸ“‹ AI CHECKLIST (UPDATED FOR API-FIRST)

**Before implementing**:
1. âœ… Check knowledge graph
2. âœ… Check architecture discussed (implement first if 60+ min discussion)
3. âœ… **Design API contracts** (backend + frontend) â­
4. âœ… **Write API contract tests** â­
5. âœ… Implement APIs
6. âœ… **Test APIs via requests** (< 1s) â­
7. âœ… Verify API tests passing â­
8. âœ… THEN build UX
9. âœ… Update PROJECT_TRACKER.md

**NO SHORTCUTS**: Test APIs first, build UX second

---

## ğŸ“ Quick Reference

### Testing Philosophy â­ CORE
**"Test the contract, trust the implementation"**
- Backend APIs: `/api/[module]/[endpoint]`
- Frontend APIs: `/api/modules/frontend-registry`
- One API test = entire call chain validated
- 60-300x faster than browser testing

### Tools
- **Feng Shui**: Architecture quality - 7 agents (`python -m tools.fengshui analyze`)
  - Architecture, Security, UX, FileOrg, Performance, Documentation, TestCoverage
- **Gu Wu**: API contract tests (`pytest tests/ -m api_contract`)
- **Shi Fu**: Ecosystem insights (`python -m tools.shifu --session-start`)

### Key Docs
- `docs/knowledge/INDEX.md` - All documentation
- [[Gu Wu API Contract Testing Foundation]] - Core methodology
- [[API-First Contract Testing Methodology]] - Complete guide

---

**Summary**: 
1. **Priority 0**: Git checkpoint before critical changes
2. **Priority 1**: Knowledge graph, docs, API-first design
3. **Priority 2**: API contract testing (backend + frontend)
4. **Priority 3**: Architecture (Feng Shui), Quality (Shi Fu)
5. **Priority 4**: Server cleanup, git workflow

**CORE INSIGHT (v4.2)**: Test API contracts consistently â†’ All contributing functions tested implicitly. This is the foundation of Gu Wu.